<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora d'emissions de CO₂</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="page-canvas">
<div class="container">
    <h2>Calculadora d'emissions de CO₂</h2>
    <h3>Transport</h3>
    <select id="transport">
      <option value="0">No faig servir transport</option>
      <option value="0.1">Bicicleta (0.1 kg CO₂/dia)</option>
      <option value="2">Autobús (2 kg CO₂/dia)</option>
      <option value="5">Cotxe (5 kg CO₂/dia)</option>
      <option value="10">Moto (10 kg CO₂/dia)</option>
    </select>
    <h3>Electricitat</h3>
    <select id="electricitat">
      <option value="1">Consum baix  (1 kg/dia)</option>
      <option value="3">Consum mitjà (3 kg/dia)</option>
      <option value="6">Consum alt (6 kg/dia)</option>
    </select>
    <h3>Dieta</h3>
    <select id="dieta">
      <option value="2">Vegetariana (2 kg/dia)</option>
      <option value="4">Mixta (4 kg/dia)</option>
      <option value="7">Carnívora (7 kg/dia)</option>
    </select>
    <h3>Reciclatge</h3>
    <label><input type="checkbox" id="vidre"> Reciclar vidre (-0,25 kg/dia)</label><br>
    <label><input type="checkbox" id="cartro"> Reciclar paper/cartró (-0,7 kg/dia)</label><br>
    <label><input type="checkbox" id="plastic"> Reciclar plàstic (-1,2 kg/dia)</label><br>
    <br><br>
    <button id="calcular">Calcular</button>
    <button id="veure">Veure historial</button>
    <button id="esborrar" draggable="true">llença'm sobre el CO₂</button>
    <canvas id="canvas" width="400" height="300"></canvas>
<script>
/* ---------- 1) Obrir la BD ---------- */
let db;
const req = indexedDB.open("BD_Emissions_Personals", 1);

req.onupgradeneeded = function(e) {
  db = e.target.result;
  db.createObjectStore("resultats", { autoIncrement: true });
};

req.onsuccess = function(e) {
  db = e.target.result;
};

/* ---------- 2) Calcular emissions ---------- */
document.getElementById("calcular").onclick = function() {
  const t = Number(document.getElementById("transport").value);
  const e = Number(document.getElementById("electricitat").value);
  const d = Number(document.getElementById("dieta").value);
  let r = 0;
  if(document.getElementById("vidre").checked) r -= 0.25;
  if(document.getElementById("cartro").checked) r -= 0.7;
  if(document.getElementById("plastic").checked) r -= 1.2;

  const total = (t + e + d + r).toFixed(2);  // kg CO₂/dia, arrodonit a 2 decimals

  // Guardar a IndexedDB
  const tx = db.transaction("resultats", "readwrite");
  tx.objectStore("resultats").add({ data: new Date(), total });

  dibuixarText(`Resultat: ${total} kg CO₂/dia`); // Mostra el resultat formatat
};

/* ---------- 3) Veure historial ---------- */
document.getElementById("veure").onclick = function() {
  const tx = db.transaction("resultats", "readonly");
  const store = tx.objectStore("resultats");
  const req = store.getAll();

  req.onsuccess = function() {
    const dades = req.result;
    if(dades.length === 0){
      dibuixarText("No hi ha historial");
      return;
    }
    let text = "Historial:\n";
    dades.forEach((r, i) => {
      text += `${i+1}) ${r.total} kg CO₂/dia\n`;
    });
    dibuixarText(text);
  };
};

/* ---------- 4) Esborrar historial ---------- */
function esborrarHistorial() {
  const tx = db.transaction("resultats", "readwrite");
  const store = tx.objectStore("resultats");
  store.clear();
  dibuixarText("Historial esborrat!");
}

/* ---------- 5) Drag & Drop ---------- */
const esborrarBtn = document.getElementById("esborrar");
const canvas = document.getElementById("canvas");

esborrarBtn.addEventListener("dragstart", (e) => {
  e.dataTransfer.setData("text/plain", "esborrar");
});

canvas.addEventListener("dragover", (e) => {
  e.preventDefault();
});

canvas.addEventListener("drop", (e) => {
  e.preventDefault();
  const data = e.dataTransfer.getData("text/plain");
  if(data === "esborrar") {
    esborrarHistorial();
  }
});

/* ---------- 6) Dibuixar al Canvas ---------- */
function dibuixarText(text) {
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.font = "16px Arial";
  const linies = text.split("\n");
  linies.forEach((l, i) => ctx.fillText(l, 50, 30 + i*20));
}
</script>
    <p style="margin-top: 20px;">
      <a href="index.html">Tornar a l'índex</a>
    </p>
</div>
</body>
</html>
