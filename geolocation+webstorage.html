<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ubicaci√≥ i CO‚ÇÇ</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="pagina-geo">
<div class="contenidor">
    <h2>Emissions de CO‚ÇÇ en ruta</h2>
    <p>
    Selecciona el teu mitj√† de transport i comen√ßa a moure't. L'aplicaci√≥ calcular√† 
    el CO‚ÇÇ que est√†s emetent (o estalviant) en temps real segons la dist√†ncia recorreguda.
    </p>
    <label for="transport">Mitj√† de transport:</label>
    <select id="transport">
      <option value="0">Caminant / Bici (0 kg CO‚ÇÇ/km)</option>
      <option value="0.103">Moto (0.103 kg CO‚ÇÇ/km)</option>
      <option value="0.192">Cotxe (0.192 kg CO‚ÇÇ/km)</option>
      <option value="0.105">Bus (0.105 kg CO‚ÇÇ/km)</option>
    </select>
    <br>
    <button id="iniciar">Iniciar seguiment</button>
    <button id="aturar" disabled>Aturar seguiment</button>
    <button id="esborrar">Esborrar ruta</button>
    <div class="informacio" id="resultat">
    Cap ubicaci√≥ obtinguda encara.
    </div>

    <!-- Instruccions visuals per a la Demo -->
    <details>
        <summary>‚ÑπÔ∏è Guia: Com simular moviment</summary>
        <ol>
            <li>Prem <strong>F12 o (Ctrl + Shift + i)</strong> per obrir les Eines de Desenvolupador.</li>
            <li>Prem <strong>(Ctrl + Shift + P)</strong> per obrir el cercador d'ordres.</li>
            <li>Escriu <strong>"Sensors"</strong> i selecciona l'opci√≥ <em>"Show Sensors"</em>.</li>
            <li>A la pestanya nova que s'obre a baix, busca l'apartat <strong>"Location"</strong>.</li>
            <li>Canvia la ciutat (ex: de "London" a "Moscow") i veur√†s com augmenta la dist√†ncia.</li>
        </ol>
    </details>

<script>
  const resultat = document.getElementById("resultat");
  let idSeguiment = null;
  let distanciaTotal = 0;
  let co2Total = 0;
  let ultimaLat = null;
  let ultimaLon = null;

// Funci√≥ per calcular dist√†ncia entre dos punts (F√≥rmula de Haversine)
function calcularDistancia(lat1, lon1, lat2, lon2) {
  const radiTerraKm = 6371; // Radi de la Terra en km
  const difLat = (lat2 - lat1) * Math.PI / 180;
  const difLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(difLat/2) * Math.sin(difLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(difLon/2) * Math.sin(difLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return radiTerraKm * c; // Dist√†ncia en km
}

/* ==========================================================================
   API 1: WEB STORAGE (localStorage - Recuperar)
   ========================================================================== */
const ubicacioGuardada = localStorage.getItem("ubicacio");
if (ubicacioGuardada) {
  try {
    const u = JSON.parse(ubicacioGuardada);
    resultat.innerHTML =
      `<strong>√öltima sessi√≥ guardada:</strong><br>
       Latitud: ${u.lat}<br>
       Longitud: ${u.lon}<br>
       Transport: ${u.textTransport}<br>
       Dist√†ncia: ${u.dist} km<br>
       CO‚ÇÇ Em√®s: ${u.co2} kg`;
  } catch (e) {
    console.error("Error llegint les dades guardades:", e);
  }
}

document.getElementById("iniciar").onclick = function () {
  if (!navigator.geolocation) {
    resultat.textContent = "La geolocalitzaci√≥ no est√† disponible.";
    return;
  }

  // Reiniciem comptadors
  distanciaTotal = 0;
  co2Total = 0;
  ultimaLat = null;
  ultimaLon = null;

  document.getElementById("iniciar").disabled = true;
  document.getElementById("aturar").disabled = false;
  resultat.innerHTML = "Iniciant seguiment...";

  /* ==========================================================================
     API 2: GEOLOCATION API (watchPosition)
     ========================================================================== */
  idSeguiment = navigator.geolocation.watchPosition(
    function (pos) {
      // Llegim el transport en temps real per si l'usuari el canvia durant la ruta
      const selector = document.getElementById("transport");
      const factorTransport = parseFloat(selector.value);
      const textTransport = selector.options[selector.selectedIndex].text;

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      let distanciaParcial = 0;
      // Calcular dist√†ncia si tenim un punt anterior
      if (ultimaLat !== null && ultimaLon !== null) {
        distanciaParcial = calcularDistancia(ultimaLat, ultimaLon, lat, lon);
        distanciaTotal += distanciaParcial;
        // Acumulem CO2: km recorreguts * factor del vehicle
        co2Total += distanciaParcial * factorTransport;
      }
      ultimaLat = lat;
      ultimaLon = lon;

      /* ==========================================================================
         API 1: WEB STORAGE (localStorage - Guardar)
         ========================================================================== */
      
      // Guardem l'estat actual directament
      const ubicacio = { lat, lon, textTransport, dist: distanciaTotal.toFixed(3), co2: co2Total.toFixed(3) };
      localStorage.setItem("ubicacio", JSON.stringify(ubicacio));

      // Feedback visual segons si contamines o no
      const colorCO2 = factorTransport > 0 ? "red" : "green";
      
      resultat.innerHTML =
        `<strong>Ubicaci√≥ actual (Seguiment actiu):</strong><br>
         Latitud: ${lat.toFixed(5)}<br>
         Longitud: ${lon.toFixed(5)}<br>
         <strong>Dist√†ncia recorreguda: ${distanciaTotal.toFixed(3)} km</strong><br>
         <span style="color: ${colorCO2}; font-weight: bold; font-size: 1.2em;">üí® CO‚ÇÇ Acumulat: ${co2Total.toFixed(3)} kg</span>`;
    },
    function (error) {
      // Gesti√≥ de tots els codis d'error
      switch(error.code) {
        case error.PERMISSION_DENIED:
          resultat.textContent = "Error: Perm√≠s denegat per l'usuari.";
          break;
        case error.POSITION_UNAVAILABLE:
          resultat.textContent = "Error: La informaci√≥ de la ubicaci√≥ no est√† disponible.";
          break;
        case error.TIMEOUT:
          resultat.textContent = "Error: La petici√≥ ha caducat (timeout).";
          break;
        default:
          resultat.textContent = "Error desconegut: " + error.message;
          break;
      }
      // Restablir botons
      document.getElementById("iniciar").disabled = false;
      document.getElementById("aturar").disabled = true;
    }
  );
};

// Aturar seguiment
document.getElementById("aturar").onclick = function () {
  if (idSeguiment !== null) {
    navigator.geolocation.clearWatch(idSeguiment);
    idSeguiment = null;
    resultat.innerHTML += "<br><strong>Seguiment aturat.</strong>";
    document.getElementById("iniciar").disabled = false;
    document.getElementById("aturar").disabled = true;
  }
};

/* ==========================================================================
   API 1: WEB STORAGE (localStorage - Esborrar)
   ========================================================================== */
document.getElementById("esborrar").onclick = function () {
    localStorage.removeItem("ubicacio");
    resultat.textContent = "Ubicaci√≥ esborrada del navegador.";
};
</script>
    <p style="margin-top: 20px;">
      <a href="INDEX_history.html">Tornar a l'√≠ndex</a>
    </p>
</div>
</body>
</html>
