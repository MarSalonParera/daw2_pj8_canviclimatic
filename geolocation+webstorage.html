<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cercador de Contaminaci√≥</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- OpenLayers (Mapa) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
</head>
<body class="pagina-geo">
    <div class="contenidor">
        <header>
            <h2>üåç Qualitat de l'aire en temps real</h2>
        </header>
        <main>
            <div class="informacio">
                <p>Analitzem dos gasos clau com a indicadors de combusti√≥ (ja que el CO‚ÇÇ √©s global i no es monitora en temps real a les ciutats):</p>
                <ul class="llista-explicacio">
                    <li><strong>Di√≤xid de Nitrogen (NO‚ÇÇ):</strong> Indicador de combusti√≥ de combustibles f√≤ssils a alta temperatura (tr√†nsit, ind√∫stria).</li>
                    <li><strong>Mon√≤xid de Carboni (CO):</strong> Resultat de la combusti√≥ incompleta (vehicles, biomassa). √âs un gas t√≤xic en altes concentracions.</li>
                    <li><em>* Les dades es mostren en Œºg/m¬≥ (micrograms per metre c√∫bic).</em></li>
                </ul>
            </div>
            <p>Escriu el nom d'una regi√≥ per consultar la qualitat de l'aire en temps real.</p>
            <!-- Cercador -->
            <div class="cercador-wrapper">
                <input type="text" id="input-ciutat" placeholder="nom d'un pa√≠s o localitat" class="input-ciutat">
                <button id="btn-cercar" class="btn-no-margin">üîç Cercar</button>
            </div>

            <!-- Resultats -->
            <div id="resultats" class="caixa-resultats">
                <h3>Qualitat de l'aire a: <span id="nom-ciutat" class="titol-resultats">-</span></h3>
                
                <div class="layout-dades">
                    <div class="col-dades">
                        <p>üöó <strong>NO‚ÇÇ:</strong> <span id="val-no2">-</span> Œºg/m¬≥ <span id="nivell-no2"></span></p>
                        <p>üî• <strong>CO:</strong> <span id="val-co">-</span> Œºg/m¬≥ <span id="nivell-co"></span></p>
                    </div>
                </div>
                <p class="nota-peu">üì° Dades en temps real de l'API Open-Meteo</p>
            </div>

            <div id="mapa" class="mapa-cercador"></div>
        </main>

        <footer>
            <p class="marge-top-20"><a href="INDEX_history.html">Tornar a l'√≠ndex</a></p>
        </footer>
    </div>

    <script>
        let map, view, markerLayer;

        function iniciar() {
            // 1. Inicialitzar Mapa
            view = new ol.View({
                center: ol.proj.fromLonLat([0, 20]), 
                zoom: 2
            });

            map = new ol.Map({
                layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
                target: 'mapa',
                view: view
            });

            // 2. Event Cercar
            document.getElementById('btn-cercar').addEventListener('click', cercarCiutat);
        }

        async function cercarCiutat() {
            const input = document.getElementById('input-ciutat');
            const ciutat = input.value;
            if (!ciutat) return;

            document.getElementById('btn-cercar').textContent = "‚è≥ Cercant...";
            
            try {
                // PAS 1: Geocoding (Obtenir coordenades del nom) - API Nominatim
                const respGeo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${ciutat}`);
                const dataGeo = await respGeo.json();

                if (dataGeo.length === 0) throw new Error("Ciutat no trobada");

                const lat = parseFloat(dataGeo[0].lat);
                const lon = parseFloat(dataGeo[0].lon);
                const nomTrobat = dataGeo[0].display_name.split(',')[0]; // Agafem nom√©s la primera part del nom

                // PAS 2: Dades Contaminaci√≥ - API Open-Meteo
                const respAir = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=nitrogen_dioxide,carbon_monoxide`);
                const dataAir = await respAir.json();

                mostrarResultats(nomTrobat, lat, lon, dataAir.current);

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                document.getElementById('btn-cercar').textContent = "üîç Cercar";
            }
        }

        function interpretarNivell(valor, tipus) {
            let nivell = "";
            let color = "";

            if (tipus === 'no2') {
                // Classificaci√≥ NO2
                if (valor < 10) { nivell = "Baix"; color = "#55a630"; }
                else if (valor < 30) { nivell = "Moderat"; color = "#ffb703"; }
                else { nivell = "Alt"; color = "#d90429"; }
            } else {
                // Classificaci√≥ CO
                if (valor < 1000) { nivell = "Baix"; color = "#55a630"; }
                else if (valor < 5000) { nivell = "Moderat"; color = "#ffb703"; }
                else { nivell = "Alt"; color = "#d90429"; }
            }
            return `<span style="color: ${color}; font-weight: bold; margin-left: 5px;">(${nivell})</span>`;
        }

        function mostrarResultats(nom, lat, lon, dades) {
            // Actualitzar Textos
            document.getElementById('nom-ciutat').textContent = nom;
            document.getElementById('val-no2').textContent = dades.nitrogen_dioxide;
            document.getElementById('nivell-no2').innerHTML = interpretarNivell(dades.nitrogen_dioxide, 'no2');
            document.getElementById('val-co').textContent = dades.carbon_monoxide;
            document.getElementById('nivell-co').innerHTML = interpretarNivell(dades.carbon_monoxide, 'co');

            document.getElementById('resultats').style.display = 'block';

            // Moure Mapa i Marcador
            const pos = ol.proj.fromLonLat([lon, lat]);
            view.animate({ center: pos, zoom: 10 });

            if (markerLayer) map.removeLayer(markerLayer);
            const marker = new ol.Feature({ geometry: new ol.geom.Point(pos) });
            marker.setStyle(new ol.style.Style({
                image: new ol.style.Circle({ radius: 10, fill: new ol.style.Fill({ color: '#005f73' }), stroke: new ol.style.Stroke({color: 'white', width: 2}) })
            }));
            markerLayer = new ol.layer.Vector({ source: new ol.source.Vector({ features: [marker] }) });
            map.addLayer(markerLayer);
        }

        window.addEventListener("load", iniciar);
    </script>
</body>
</html>